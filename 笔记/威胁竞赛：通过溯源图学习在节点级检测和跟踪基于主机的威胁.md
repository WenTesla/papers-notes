# 威胁竞赛：通过溯源图学习在==节点级检测==和跟踪基于主机的威胁



THREATRACE，这是一种基于异常的检测器，能够在节点层面高效检测隐秘且持久的基于主机的威胁。THREATRACE 将数据溯源图作为源输入，并定制了一个归纳图神经网络框架（GraphSAGE）[11]，以学习数据溯源图中丰富的上下文信息。

## 挑战与解决方式

- 在没有零日攻击模式先验知识的情况下，如何训练模型
- 如何解决数据不平衡的问题

------

- THREATRACE学习数据来源图中每个良性节点的角色，在不事先了解攻击模式的情况下捕获隐形异常行为。
- 我们设计了一个多模型框架来学习不同类型的良性节点，解决了数据不平衡的问题，有效提高了检测性能。

## 工作点

- **新颖的节点级威胁检测**。据我们所知，THREATRACE是第一项将基于主机的威胁检测问题形式化为出处图中的异常节点检测和追踪问题的研究。
- 我们提出了一种新颖的基于GraphSAGE的多模型框架，以在节点级别检测隐秘威胁。**具备高检测性能和新颖的能力**。

- **完整系统且开源**。

[1]: https://github.com/threaTrace-detector/threaTrace/

数据溯源在主机威胁检测领域具有吸引力。相关研究可分为基于误用和基于异常两类。

![img](https://cdn.xljsci.com/literature/163655982/page4/t1l2zb.png)

## 威胁模型

隐蔽性。攻击者并非简单地实施攻击，而是有意识地隐藏其恶意活动，试图将其行为与大量良性背景数据混在一起，使得受害系统表现得如同处于良性模式。 

持久性。入侵活动往往会持续很长时间。

频繁使用零日漏洞。攻击者倾向于使用零日漏洞来攻击系统。因此，我们假设没有任何可用于训练的攻击模式。

在起源图中存在攻击模式。为了完成与良性活动不同的恶意活动，攻击者的行为应该在起源中留下一些攻击模式。这些攻击模式会使攻击者节点的局部结构与具有相同标签的良性节点的局部结构不同。

## 设计

（§V-A）数据溯源生成器。该组件以流模式收集主机的审计数据，并将其转换为溯源图，以供后续分析。

（§V - B）数据存储。该组件将数据分配到磁盘和内存中。我们将**整个图存储在磁盘上**以保存历史信息，并在**内存中维护一个大小有限的子图**用于训练和检测。这种存储策略保证了THREATRACE的可扩展性（P4）和动态检测能力。（§V - C）模型。这是THREATRACE的核心组件。我们以前两个组件生成和分配的图数据作为输入，并输出异常节点。

  (§v - c)模型。这是THREATRACE的核心组件。我们使用前两个组件生成和分配的图数据作为输入和输出异常节点。

（§V-D）警报和跟踪。我们从前一个组件中获取异常节点，并确定是否在该组件中发出警报并跟踪异常。我们设置了等待时间阈值和容忍度阈值，以减少误报并确定是否发出警报。由于THREATRACE在节点级别检测威胁，因此我们直接跟踪异常行为在异常节点的本地邻居中的位置。

### 数据源生成器

使用外部工具 Camflow [33] 来构建一个按时间顺序排列的单一的全系统溯源图

> [CamFlow：适用于 Linux 的实用全系统来源](https://camflow.org/#graph)

### 数据存储

将前一个模块中的图形数据分配到磁盘和内存以供以后使用

在流模式下，我们**将传入的节点和边追加到存储在磁盘上的整个图中**。我们还在内存中维护一个由活*跃节点、相关节点*以及它们之间的边组成的子图。上图的1b就是子图的例子。蓝色节点表示活跃节点，灰色节点表示相关节点。

*活跃节点定义为图中用于训练或检测的实体*

*能够在两跳内到达活跃节点的节点称为相关节点，这些节点包含用于训练或检测的历史信息*

### 模型

定制了一种**特征提取和标签分配**方法，使 THREATRACE 能够在无异常数据的情况下以监督模式训练模型，并学习每个良性节点的局部结构信息。

#### 提取过程

训练前，我们首先统计不同节点类型（如文件、进程、套接字）和边类型（如读取、写入、分叉）的数量，分别记为 N ~n~  和 N~e~

设置节点类型和边类型映射函数将节点类型和边类型映射到从 0 到 N  ~n~ − 1，以及从 0 到 N  ~e~  −1 的整数范围。



#### 训练方法

整个训练图划分为几个子图。每个子图由一定数量（本文中设为 150,000）的随机选择的活跃节点、与其相关的节点以及它们之间的边构成



##### 多模型训练

![img](https://oss.xljsci.com//literature/163655982/page0/1750917801828.png)

设计了一种基于概率的方法，以进一步降低产生误报的风险

### 执行

在执行阶段，我们在内存中维护一个子图 G  。 G  最初为空，并不断追加新到达的节点和边。传入边的目标节点及其 2 跳后代被定义为活动节点。后代及相关节点从磁盘上的整个图中获取。我们设置了一个名为子图大小（SS）的参数。当新到达的边的数量达到 SS 时，我们使用 G进行检测，并开始在内存中构建一个新的子图。



### 警报与追踪

该组件从前面的组件接收异常节点，并将它们存储在队列 Q 中。我们设置了一个时间阈值 T，并动态维护队列 Q，而不是直接向受监控系统发出警报。



## 评估

基于异常的主机威胁检测器：==Unicorn==, ProvDetector, and ==StreamSpot==

异常日志检测器：Log2vec, ==DeepLog==, ==LogRobust== and ==LogGAN==

数据集：StreamSpot, Unicorn SC-1 and SC-2, DARPA TC #3 and #5

**开源：StreamSpot、Unicorn 和 LogGAN**

**不开源：ProvDetector**

**其他人复现：DeepLog 和 LogRobust**

向作者要的：LogRobust

#### STREAMSPOT DATASET



![STREAMSPOT DATASET](https://cdn.xljsci.com/literature/163655982/page10/vc2894.png)

 6×100 个信息流图，这些图源自五个良性场景和一个攻击场景

良性场景涉及不同的良性活动：查看 Gmail、浏览CNN.com、下载文件、观看 YouTube 视频以及玩电子游戏

攻击场景涉及一次诱导式下载攻击。

这个数据集没有时间戳，**无法使用ProvDetector复现**

> ProvDetector需要时间戳



![img](https://cdn.xljsci.com/literature/163655982/page10/yd4vwm.png)

#### Unicorn DataSet

![img](https://cdn.xljsci.com/literature/163655982/page10/xrdkb3.png)



![img](https://cdn.xljsci.com/literature/163655982/page10/4e7sdx.png)

Unicorn 性能较低的原因在 Unicorn 的论文 [7] 中有介绍：攻击者对系统有先验知识，因此其行为比其他数据集的攻击者更为隐蔽

#### DARPA TC  DataSet

![img](https://cdn.xljsci.com/literature/163655982/page11/pyy4td.png)

这个数据集具有日志？

![img](https://cdn.xljsci.com/literature/163655982/page11/i6qygu.png)



