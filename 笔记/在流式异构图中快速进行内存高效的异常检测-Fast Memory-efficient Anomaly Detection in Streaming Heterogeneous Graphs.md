# 在流式异构图中快速进行内存高效的异常检测-Fast Memory-efficient Anomaly Detection in Streaming Heterogeneous Graphs(StreamSpot)





- 新颖的表述和图相似性：我们将主机级 APT 检测问题表述为流式异构图中基于聚类的异常检测任务。为了实现有效聚类，我们为**带时间戳**的类型图设计了一个新的相似性函数，该函数基于 shingling，它解释了图中不同子结构的频率。除了可以有效地计算和有效地捕捉图之间的相似性外，所提出的函数还有助于根据它们的草图比较两个图，从而实现内存效率。
- 动态维护：我们引入高效的技术，使我们方法的各个组成部分在新的边缘到达时保持最新状态。具体来说，我们将展示如何维护 （a） 图形草图，以及 （b） 增量聚类。
- 理想的特性：我们的配方和建议的技术是由应用领域的要求和期望特性驱动的。因此，我们的方法是 （i） **完全流式处理**，其中我们对流执行连续的边缘级处理，而不是采用面向快照的方法;（ii） 时间效率高，每条边的处理速度很快，复杂度恒定，以更新其图形的草图和聚类;（iii） 内存效率高，草图和集群摘要消耗由用户输入控制的恒定内存，以及 （iv） 在线，我们实时评分和标记异常。





### 绘制图

![img](https://cdn.xljsci.com/literature/164878658/page2/cjp0io.png)

### 算法

#### k-shingle（初始化）

给定图G = (V, E)和节点V 2v，则k-shingle s(V, k)是通过从V开始的**k跳**宽度优先遍历构造的**字符串**

1. 初始化k-shingle为节点v的类型:s(v, k) = v
2. 按照时间戳t的顺序遍历每个节点的出线边
3. 对于每个具有目的地w的遍历边e，用k-shingle将边和目标节点的类型连接起来:$S(v,k)=S(v,k)\oplus \phi_{e} \oplus \phi_{w}  $  

较大的k会产生更具表现力的局部邻域，而较小的k则需要在每个传入边的shingle向量中更新较少的条目。



#### shingle (frequency) vector



![img](https://cdn.xljsci.com/literature/164878658/page3/czir6b.png)
$$
sim(G,G')=\frac{z_Gz_{G'}}{|z_{G}||z_{G'}|}
$$
直观来说，两个图共享的 shingles 越多，相似度越高

### 通过哈希法绘制的图形草图

由于可能有大量的节点和边类型，k 瓦片的宇宙 S 可能会组合爆炸，并导致无法为每个图存储 \(|S|\) 维瓦片向量。我们现在提出了一种替代的恒定空间图表示，它通过位置敏感哈希 （LSH） [17] 来近似瓦片计数向量。

> 局部敏感哈希（LSH）方案通过将高维向量投影到低维空间来实现高效的相似度计算，同时保留向量间的相似性。对于给定的相似度函数，LSH 的核心思想是设计哈希函数，使得相似的向量更可能被映射到相同的哈希桶，而不相似的向量则更可能被映射到不同的桶。

#### SimHash

生成 L 个随机投影向量 *r*1,…,*rL*（如从高斯分布中随机选取)

对于输入向量 *z*，计算其与每个投影向量的点积，并根据符号（正或负）生成哈希值$h_{rl}=sign(z*rl)$

最终，向量 *z* 的 SimHash 草图为 **L 位**的二进制向量

> 矩阵的点乘，例如：
>
> zG*r1：0-1-1+1-1-1=-3

![img](https://oss.xljsci.com//literature/164878658/page0/1751103282476.png)

相似度：
$$
p(h_{rl}(Z_G)=h_{rl}(Z_{G'}))=1-\frac{cos^{-1}(\frac{z_Gz_{G'}}{|z_{G}||z_{G'}|})}{\pi}
$$
问题：

随着新边和/或新图的到来，我们需要对变化或新出现的shingle向量执行相同的一组随机投影

缺点：

**(1)它需要显式的内存投影向量，(2)|S|仍然可能变得过大，(3)它需要知道完整的单个图|S|的大小来指定每个随机向量的维度**

#### ==StreamHash==

- **哈希函数选择**：使用强通用哈希函数族，将 shingles 映射到{+1,−1}，确保哈希值的**均匀性和独立性**。
- **增量更新**：新边到达时，通过更新投影向量 *y**G*（点积和）和草图 *x**G*，无需维护完整 shingle 向量，实现常数时间更新。

这种算法是用L个哈希函数，将直方图中的元素进行映射，这里的每个哈希函数是一个S1维的向量

下面是代码的例子，cpp写的

![img](https://i-blog.csdnimg.cn/blog_migrate/aa89cc4d3049af141d39733f7109b1d5.png)

![img](https://i-blog.csdnimg.cn/blog_migrate/fbc3cbdfa97e1586906e000bd6264a59.png)

hashmulti函数将对应的哈希函数（S*1维的向量）与字符串相对应的字符进行运算，返回结果为+1或-1。





### 合并草图

两个图G和\(G'\)的并集的向量是它们各自向量的总和：
$$
z_{G \cup G'}=z_{G}+z_{G'}
$$


### 时间空间复杂度

时间：L+|S|^2^ 

那么总的空间复杂度为\(O(c L+N)\) ）。



## 评估

(1) 静态：我们使用所有良性图中的\(p \%\)进行训练，其余良性图与攻击图一起用于测试。我们对训练图进行离线聚类，然后根据该聚类对测试图进行评分和排序。图由其文档片段向量表示，所有所需数据都存储在内存中。目标是在引入用于时间和空间优化的近似方法之前，量化StreamSpot的有效性。

(2) 流式处理：我们使用良性图中的\(p \%\)进行训练，首先离线构建一个自举聚类。这用于初始化StreamSpot，然后将测试图以流的形式输入，并每次在线处理一条边。因此，在任何给定时间，测试图可能只能部分可见。对于每条边，StreamSpot会更新相应的图草图、聚类、聚类分配和异常分数，并且每处理10,000条边就保留一份异常分数的快照用于评估。StreamSpot还通过限制草图大小和存储边的最大数量，在内存约束下进行评估。



### 静态

- **现象**：在流式异构图中（如系统调用流图），由于图的低直径和大出度特性，即使 k 值较小（如 k=1），生成的 shingle 也可能很长（包含大量节点和边类型）。
- **影响**：相似图的 shingle 可能仅因少数字符不同而被判定为 “不相似”，导致图间距离分布不合理（如大部分图对相似度低），影响聚类和异常检测效果。
- **解决**：我们将每个子图“分块”成固定大小的单元。分块长度参数控制着图结构和节点类型频率对图对之间相似性的影响。**较小的分块长度参数会降低结构的影响，而更多依赖于节点类型的频率，使得大多数图对相似。较大的分块长度参数则倾向于使图对之间的差异更大。**

![数据集](https://oss.xljsci.com//literature/164878658/page0/1751176450330.png)

![img](https://oss.xljsci.com//literature/164878658/page0/1751176485388.png)

显示了每个数据集随**C**变化的成对距离的熵。在最大熵点，距离几乎均匀分布

![img](https://oss.xljsci.com//literature/164878658/page0/1751177379079.png)

- **c 决定相似度计算方式**：合适的`c`确保相似图的距离足够小，便于聚类；
- **K 决定正常模式的划分**：合适的`K`确保每个簇对应单一正常模式，异常图的距离显著偏离簇质心。

| 参数 | 全称               | 作用领域     | 关键影响                     | 选择方法               |
| ---- | ------------------ | ------------ | ---------------------------- | ---------------------- |
| c    | chunk length       | shingle 处理 | 控制图相似度计算的结构敏感性 | 基于距离分布熵的最大化 |
| K    | number of clusters | 聚类分析     | 控制正常行为模式的划分粒度   | 基于轮廓系数的最大化   |

![img](https://oss.xljsci.com//literature/164878658/page0/1751178036276.png)



![img](https://oss.xljsci.com//literature/164878658/page0/1751177883603.png)

### 流媒体

![img](https://cdn.xljsci.com/literature/164878658/page8/pt93mc.png)

![img](https://cdn.xljsci.com/literature/164878658/page8/xy4uqa.png)

(i)检测性能遵循一个趋势，周期性下降，然后恢复。(ii)每次下降对应一组新图的到来。最初，只有一小部分新图可用，检测性能不太准确。然而，随着图的增长，性能恢复得很快;图10中性能的急剧上升意味着很小的异常检测延迟。(iii)恢复后的平均精度表明攻击图在顶部的排名接近理想。(iv)随着看到的数据越来越多，聚类变得更加“成熟”，下降变得不那么严重;这在准确率的总体上升趋势中是显而易见的。(v)准确性损失不是由于排名(因为AP和AUC都很高)，而是由于从自举聚类中得出的所选异常阈值，其中误差是由于假阴性造成的