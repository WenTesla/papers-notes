# LogContrast: A Weakly Supervised Anomaly Detection Method Leveraging Contrastive Learning

# LogContrast：利用对比学习的弱监督异常检测方法

## 局限

依赖标签

训练集含噪声标签会降低模型性能，测试集噪声标签导致评估错误

日志因系统更新不断演化，仅依赖日志键序列的模型易出现词汇表外问题，误判新日志键为异常。

![img](https://cdn.xljsci.com/literature/182232683/page2/zzmgtu.png)

## 贡献

- 我们提出了LogContrast，这是一种异常检测方法，它利用弱监督对比学习来解决现实中日志标签稀缺且存在错误的问题。该方法仅使用一部分标签来这种方法仅使用部分标签进行有监督训练，从而减少由噪声日志标签导致的训练偏差。
- 我们在LogContrast中设计了日志语义特征提取器（LSFE）和日志键序列特征提取器（LKFE），它们能更全面地从系统日志中提取特征，使该方法能够适应日志的修改或演变。
- 我们研究了语义特征和日志键序列特征在异常检测任务中的作用，并提供了可视化结果来说明这两种特征的特点。



## 半监督学习

- 不完全监督涉及到只有部分输入数据被标记的情况。
- 当检测到的标签没有达到所需的精确程度时，就会出现不精确监督。例如，由于标注成本的原因，可能只有粗粒度的标签信息可用。
- 不准确的监督指的是标签被噪声干扰的问题，这可能是由标注错误和机器失误导致的。

## 设计

![img](https://cdn.xljsci.com/literature/182232683/page4/9t9iy9.png)

- **日志解析**：采用 Spell、Drain 等方法将半结构化日志转为结构化模板，得到日志模板序列、日志键序列及标签。
- **特征提取与融合**：
  - **LSFE**：基于预训练 BERT 模型提取日志语义特征，冻结除输出层外的参数以保留泛化能力，捕捉 “error”“shutdown” 等异常指示语义。
  - **LKFE**：基于 Transformer 编码器提取日志键序列特征，用可学习位置编码与批量归一化替代层归一化，适配序列建模，捕捉事件间时序关系（如正常行为 EventA→EventB 与异常行为 EventB→EventA）。
  - 特征融合：将语义特征（\(F_S\)）与日志键序列特征（\(F_K\)）拼接，得到融合特征\(F=F_S \oplus F_K\)。

- **特征增强与对比学习**：
  - 用 dropout 对融合特征增强，生成正例特征\(F_+\)（同一日志的增强特征），同一批次其他融合特征为负例。
  - 采用 InfoNCE 损失计算对比损失（\(\mathcal{L}_{cl}\)），结合交叉熵损失（\(\mathcal{L}_{ce}\)）构成总损失\(\mathcal{L}=\mathcal{L}_{ce}+\lambda_{cl}\mathcal{L}_{cl}\)，平衡自监督与监督信号。
- **异常检测**：训练阶段从日志序列预测异常概率中选最优 F1 分数对应的概率作为阈值\(p_{th}\)，测试时若日志序列异常概率≥\(p_{th}\)则判定为异常。





## 实验

#### 1. 实验设置

- **数据集**：采用 Loghub 的 HDFS（分布式系统日志，会话窗口分组）与 BGL（超级计算机日志，固定窗口分组），训练集随机选 10000 条日志，测试集用全量数据，两类数据集均为异常日志占比低的不平衡数据。
- **评估指标**：精确率（Precision）、召回率（Recall）、F1 分数、准确率（Accuracy）。
- **对比方法**：5 种主流方法（半监督的 DeepLog、LogAnomaly、LogBERT、LogEncoder，监督的 LogRobust）。

#### 2. 核心实验结论

- **RQ1（方法有效性）**：LogContrast 在 HDFS 数据集上 F1 分数达 0.973，优于所有对比方法；在 BGL 数据集上 F1 分数 0.955，仅略低于监督方法 LogRobust（0.975），整体性能领先。
- **RQ2（标签稀缺问题）**：当监督标签比例\(r_{sup}\)从 0 增至 0.2 时，各指标显著提升，且性能接近\(r_{sup}=1.0\)的全监督方法，证明少量标签即可缓解标签稀缺问题。
- **RQ3（噪声标签抗性）**：低噪声（\(r_{noise}≤0.2\)）时弱监督（\(r_{sup}=0.2\)）性能略低于全监督（\(r_{sup}=1.0\)）；高噪声（\(r_{noise}≥0.3\)）时，弱监督方法在召回率、F1 分数、准确率上更优，抗噪声能力更强。
- **RQ4（特征作用）**：日志键序列特征区分正常与异常日志的能力更强（HDFS 数据集上 LogContrast-logkey 的 F1 达 0.9856）；语义特征在 BGL 数据集表现优异（F1 0.9496），二者融合在 BGL 数据集进一步提升性能，需根据数据集特性选择特征组合。
- **RQ5（日志演化适应性）**：LogContrast-sem（仅语义特征）在 50% 日志演化（插入 / 删除 / 替换 token、打乱 token）时仍保持高指标，而仅依赖日志键序列的模型易因新日志键出现词汇表外问题，证明语义特征适配日志演化。
- **RQ6（dropout 率影响）**：dropout 率从 0.1 增至 0.3 时，模型性能略有下降（HDFS 数据集 F1 从 0.9732 降至 0.9696），因增强特征与原始特征差异增大，增加对比学习难度，故推荐 dropout 率 0.1。