# HitAnomaly：用于系统日志异常检测的分层Transformer

## 摘要

在本文中，我们提出了HitAnomaly，这是一种基于日志的异常检测模型，它利用**分层 transformer 结构来对日志模板序列和参数值进行建模**。我们设计了日志序列编码器和参数值编码器，分别获取它们的表示。然后，我们**使用注意力机制作为最终的分类模型**。通过这种方式，HitAnomaly 能够捕获日志模板序列和参数值中的语义信息，并处理各种类型的异常。我们在三个日志数据集上对所提出的方法进行了评估。实验结果表明，HitAnomaly 优于其他现有的基于日志的异常检测方法。我们还评估了所提出模型在不稳定日志数据上的鲁棒性。



## 设计

### 日志序列编码

![img](https://cdn.xljsci.com/literature/178103317/page5/3i9xm6.png)

假设一个日志模板序列包含N个日志模板。运行日志编码后，我们得到一个日志表示列表\(R_{L}=[R_{L 1}, R_{L 2}, ..., R_{L N}]\)，其中\(R_{L N}\)是第N个日志表示。在日志模板表示序列\(R_{L}\) 9上运行Transformer层后，我们得到上下文敏感的日志模板表示\(Z_{L}=[z_{L 1}, z_{L 2}, ..., z_{L N}]\)  
$$
Z_{L}= TransformerBlock \left(R_{L}\right) \quad
$$
日志序列编码器还应用了一个平均层，将日志模板表示\(Z_{L}\)转换为最终的日志序列表示\(R_{s}\) 。
$$
R_{s}=\frac{1}{N} \sum_{i=1}^{N} Z_{i}
$$

### 参数值编码

HitAnomaly 的参数值编码针对这些问题，核心要实现两个目标：

1. **建模参数值的序列与语义**：将参数值视为有序序列（如同一模板下多次出现的 “耗时” 参数），捕捉其正常波动范围与异常偏差；
2. **融合模板上下文**：参数值的语义依赖模板（如 “600” 在 “耗时 600 秒” 中是异常，但在 “耗时 600 毫秒” 中是正常），需关联模板信息避免误判。

####  第一步：参数值的预处理与分组

日志解析后，每个日志条目会拆分为 “模板”（如 “Took ⟨*⟩ seconds to build instance”）和 “参数值”（如 “10”“600”）。参数值编码首先按**模板分组**：将同一日志模板对应的所有参数值归为一组（如模板 “Took ⟨*⟩ seconds...” 对应的所有 “耗时” 参数值组成一个参数组）。

> 分组原因：不同模板的参数值语义完全不同（如 “耗时” 参数与 “磁盘大小” 参数无关联），分组可避免跨模板的参数干扰。

####  第二步：参数级编码（单个参数值的向量转换）

- **参数值分词**：若参数是字符串（如 IP 地址 “10.251.42.9”）或复合数值（如 “10.5GB”），用 WordPiece 分词（与 Bert 一致）拆分为子词（如 “10”“.”“251”“GB”），确保非数值型参数也能被建模；
- **Word2Vector 映射**：将分词后的子词通过预训练的 Bert 词向量矩阵，映射为子词向量（避免随机初始化导致的语义偏差）；
- **Transformer 块处理**：子词向量经过 “自注意力层（多头注意力，捕捉子词间关联，如 “10.5” 中 “10” 与 “5” 的依赖）→前馈神经网络（FFN，非线性转换增强表达）”，输出参数值的子词级向量；
- **池化层降维**：对参数值的子词级向量进行**平均池化**，得到单个参数值的固定维度向量（如 128 维），记为\(r_{v_i}\)（i为参数在组内的序号）。

#### ==第三步：模板 - 参数融合（关联模板上下文）==

这是参数值编码的核心创新点 —— 解决 “参数值语义依赖模板” 的问题。具体做法是：

- 先通过 “日志序列编码” 中的 “单日志编码器”，将当前参数组对应的**日志模板**转换为模板向量\(R_{L}\)（如模板 “Took ⟨*⟩ seconds...” 的向量）；
- 设计一个**线性融合层**，将参数值向量\(r_{v_i}\)与模板向量\(R_{L}\)进行融合，公式如下：\(R_{v\_group} = R_{L} \cdot W_1 + r_{v_i} \cdot W_2 + b\)其中\(W_1\)（模板权重矩阵）、\(W_2\)（参数权重矩阵）、b（偏置）是可训练参数，作用是让参数值向量 “绑定” 模板的语义（如 “600” 会因模板是 “seconds” 还是 “ms” 生成不同的融合向量）。
- 融合后，对同一参数组内的所有融合向量\(R_{v\_group}\)再次进行平均池化，得到**单模板 - 参数组的表征**\(R_{V}\)（如模板 “Took ⟨*⟩ seconds...” 对应的所有 “耗时” 参数的综合表征）。

#### 第四步：序列级编码（参数组的全局表征）

一个完整的日志序列包含多个不同模板的日志条目，对应多个 “模板 - 参数组表征”\(R_{V1}, R_{V2}, ..., R_{VN}\)（N为序列中模板的数量）。参数值编码的最后一步是对这些组表征进行**序列级建模**：

- 采用一个**Transformer 块**（含自注意力 + FFN）处理\(R_{V1}...R_{VN}\)，捕捉不同模板参数组间的关联（如 “磁盘占用” 参数与 “请求响应时间” 参数的联动规律）；
- 对 Transformer 输出的序列向量进行平均池化，得到最终的**参数值表征**\(R_p\)（固定维度，与日志序列表征\(R_s\)维度一致，方便后续注意力融合）

注意力分数：
$$
\alpha_{s}=\frac{exp \left(f\left(R_{s}\right)\right)}{exp \left(f\left(R_{s}\right)\right)+exp \left(f\left(R_{p}\right)\right)}
$$
 
$$
a_{p}=\frac{exp \left(f\left(R_{p}\right)\right)}{exp \left(f\left(R_{s}\right)\right)+exp \left(f\left(R_{p}\right)\right)}
$$




## 未来

异常预测而不是异常检测