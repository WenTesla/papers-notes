# APTSHIELD：稳定、高效、实时的 Linux 主机 APT 检测系统

## 挑战

- 如何选择可靠、稳定、语义丰富的数据源
- 如何减少实时检测所需的数据量，提高检测效率
- 如何构建高适应性、高覆盖、高精度、低误报和恒定内存开销的实时APT检测框架

## 应对策略

与以往研究不同的是，我们对存量数据源的优缺点进行了详细的对比分析，我们部署多个指标，然后通过性能分析和综合判断，在Linux上得到稳定APT检测的最优数据源。

我们采用**冗余语义跳过**和**非可行实体剪枝**来提高实时APT检测的效率，减少取证分析的数据存储开销，我们的数据压缩方法可以在实时流数据中进行，保证了检测系统的性能，同时在不影响最终结果准确性的情况下，压缩效果优于现有研究。

基于ATT&CK模型，我们通过系统数据流和控制流**构建了一个信息聚合框架**，借助战术、技术和程序（TTP），在框架中定义系统实体的原子可疑特征及其传输规则，实现APT攻击上下文信息的聚合，不同于传统的单点检测方法，我们的框架可以将攻击链的信息聚合到特定的实体中，以恒定的内存开销实现APT攻击的全链检测和实时报警。

我们在Linux上实现了一个稳定、高效、实时的APT检测原型系统，并在Darpa Engity的数据集上以及在真实场景中模拟APT攻击的数据集上进行了实验，实验结果表明，我们的系统能够有效地实时检测Web漏洞攻击、无文件攻击和远程访问木马攻击，且误判率低，比现有的前沿研究增加了更多的价值

## 背景

### 取证分析

帮助分析师了解攻击何时、如何以及产生什么影响

#### 任务

- 确定攻击的入口（例如，进入终端的初始进程和文件以及攻击的源 IP / 端口）  --- 逆向分析
- 使用正向分析来分析攻击的影响 [24]、[46]，例如访问敏感信息、篡改系统配置等。

> 通过事件时间戳判断因果关系，确保分析路径的逻辑顺序。例如，事件 A 的时间戳早于事件 B，且事件 B 的对象是事件 A 的主体，则事件 A 可能是事件 B 的诱因

## 系统设计

系统生成的日志被认为是可信的

#### 架构

首先，采用基于内核的工具进行数据采集。通过综合分析，我们选择**auditd**作为客户端的收集器，因为它提供了足够的数据和低开销。收集到的系统日志（包括实体和事件）将构建依赖图。

> `auditd`（Audit Daemon）是 Linux 系统中一个强大的工具，它通过记录系统活动日志，帮助管理员进行全面的安全审计和事件监控

其次，将采用冗余语义学跳过和非可行节点剪枝来压缩系统日志。数据压缩的主要优点是提高实时APT检测的效率，降低取证分析的内存成本

再次，基于 ATT&CK 模型提出 APT 检测框架；在框架中定义系统实体（即进程标签和文件标签）及其传输规则（通过不同语义的事件）的原子可疑特征，实现 APT 攻击上下文信息的聚合。APT 会从特定实体（通过判断规则）发出警报，最后通过取证分析找到相关的攻击链。

![img](https://cdn.xljsci.com/literature/163655951/page5/5xw310.png)

#### 数据收集

##### 数据要求

- 防篡改
- 稳定性和低开销
- 丰富语义学

内核级别日志满足要求

##### 数据源分析和选择

![img](https://cdn.xljsci.com/literature/163655951/page6/gxqux5.png)

Auditd性能最高

#### ==数据压缩==

##### 数据压缩洞察

要求如下

- 实时性
- 效率高
- 精度高

举例

![img](https://cdn.xljsci.com/literature/163655951/page6/j934yz.png)

观点：**如果源实体的语义没有改变，并且目标实体从源实体收到了多个相同的信息流（事件），这些事件将具有相同的语义，可以组合起来删除冗余语义**

1） 在时间 \(t1\) 之后，进程 P 已经具有 x.com 的语义，并且 \(t2\) 和 t11的事件没有引入任何新的语义，可以删除。

2） 虽然在 t5 和 \(t 7\) 期间发生了从 P 到 Q 的事件（在 t6），但它只影响 Q 的语义，P 的语义保持不变。时间 t5 和 \(t 7\) 的事件具有相同的语义，我们可以删除时间 \(t 7\) 的事件

2） 虽然在 t5 和 \(t 7\) 期间发生了从 P 到 Q 的事件（在 t6），但它只影响 Q 的语义，P 的语义保持不变。时间 t5 和 \(t 7\) 的事件具有相同的语义，我们可以删除时间 \(t 7\) 的事件

我们设计了一个时间窗口 T 来保持网络以低频率接收事件，平衡数据压缩效率与攻击检测准确性。T=50的时候效果最好

> 若直接删除所有重复网络事件，可能丢失攻击痕迹；若全部保留，则会产生大量冗余数据。

##### 冗余语义跳过

APTSHIELD 维护一个表来存储所有进程的最新语义信息。当传入事件的语义与语义表中的语义相同时，该事件可以被视为 redundant 并被删除。如果存在大量重复的读写作，删除冗余的语义事件可以大大减少执行时间和内存开销。

<img src="https://oss.xljsci.com//literature/163655951/page0/1750734018426.png" alt="img"  />

###### 非可行实体剪枝（用于减少进程数、控制内存开销）

目的：

- **减少无效进程数**：删除 “已结束且对攻击链分析无价值” 的进程，释放内存。
- **保障取证分析完整性**：仅删除不影响攻击溯源的进程，避免因误删导致关键证据丢失。

<img src="https://oss.xljsci.com//literature/163655951/page0/1750734676290.png" alt="img" style="zoom:50%;" />

满足下述两个条件下

(1)它执行退出事件，(2)它没有**潜在的有害功能（PHF）**和子节点（当子节点具有PHF时，删除父节点将影响取证分析）

该进程将从节点树中修剪。



此外，我们将非活动文件节点（在本文中定义为超过 5 分钟没有变化，时间间隔可以根据实际需要改变）移动到磁盘，以进一步降低内存开销。它们将在需要时实时从磁盘中取出。

### APT检测



#### 定义标签

<img src="https://cdn.xljsci.com/literature/163655951/page8/7ndrly.png" alt="img" style="zoom:67%;" />

状态标签表示流程中的语义将与流程 / 线程相关事件一起传递给子流程的标签。行为标签指示进程执行了哪些操作，并用于准确定位威胁。

**选择 PS2 、 3 、 5 和 PB1 、 2 、 5 作为 PHF**

#### 文件标签

**不受信任的标签和高价值标签**，文件标签的选择性列表如表 III 所示。untrusted files （不受信任的文件） 是指包含来自网络的不受信任的数据的文件，high value files （高价值文件） 是指包含敏感数据的文件。

![img](https://cdn.xljsci.com/literature/163655951/page9/i0fijr.png)



#### 事件选择



#### 转移规则

 APT 攻击分为五个主要阶段：初始访问、不受信任的执行、横向移动、可疑行为和数据泄露

可疑行为阶段包括持久据点、特权升级、凭据访问和信息收集。

![img](https://cdn.xljsci.com/literature/163655951/page10/1xgrcc.png)



#### 判断规则

攻击判断规则如下

![img](https://cdn.xljsci.com/literature/163655951/page10/tksujb.png)

## 实验

数据集由两部分组成，一部分来自我们的实验室，另一部分来自 DARPA Engagement

>  **DARPA Engagement 指美国国防高级研究计划局（DARPA）组织的网络对抗实验或数据集相关项目** 



![img](https://oss.xljsci.com//literature/163655951/page0/1750747734554.png)



## 性能

数据压缩的性能：

![img](https://cdn.xljsci.com/literature/163655951/page11/s6kmlr.png)

Darpa Engagement 数据集上节省更多时间，但是跳过少































## 个人评价

数据集不公开

使用的不是AI

